name: CD

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get the version
        id: get_version
        shell: bash
        run: |
          # GITHUB_REF_NAME is the tag, e.g. v5.0.0
          echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # Keep if your repo sometimes loses the executable bit
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --console=plain --stacktrace --no-daemon
        env:
          ORG_GRADLE_PROJECT_releaseVersion: ${{ steps.get_version.outputs.VERSION }}

      - name: Publish to OSSRH
        run: ./gradlew publish --console=plain --stacktrace --no-daemon
        env:
          ORG_GRADLE_PROJECT_releaseVersion: ${{ steps.get_version.outputs.VERSION }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_SECRET }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_PUBLIC_KEY_AMORED }}
          ORG_GRADLE_PROJECT_ossrhUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_ossrhPassword: ${{ secrets.OSSRH_PASSWORD }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            ### Install

            **Recommended:** use the BOM to keep versions aligned.

            #### Gradle (BOM + choose one module)

            ```kotlin
            dependencies {
              implementation(platform("me.paulschwarz:spring-dotenv-bom:${{ steps.get_version.outputs.VERSION }}"))

              // Choose one:
              // implementation("me.paulschwarz:spring-dotenv")
              // implementation("me.paulschwarz:springboot3-dotenv")
              // implementation("me.paulschwarz:springboot4-dotenv")
              implementation("me.paulschwarz:springboot3-dotenv")
            }
            ```

            #### Maven (BOM + choose one module)

            ```xml
            <dependencyManagement>
              <dependencies>
                <dependency>
                  <groupId>me.paulschwarz</groupId>
                  <artifactId>spring-dotenv-bom</artifactId>
                  <version>${{ steps.get_version.outputs.VERSION }}</version>
                  <type>pom</type>
                  <scope>import</scope>
                </dependency>
              </dependencies>
            </dependencyManagement>
            ```

            Then add **one**:

            - **Spring Framework (no Boot):** `me.paulschwarz:spring-dotenv`
            - **Spring Boot 3:** `me.paulschwarz:springboot3-dotenv`
            - **Spring Boot 4:** `me.paulschwarz:springboot4-dotenv`

            ```xml
            <dependency>
              <groupId>me.paulschwarz</groupId>
              <artifactId>springboot3-dotenv</artifactId>
            </dependency>
            ```
